<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Puantaj Sistemi</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { font-family: Arial; padding: 20px; }

.baslikRow {
display: flex;
justify-content: space-between;
align-items: center;
}

.puantajBaslik {
font-size: 26px;
font-weight: bold;
}

.tarih {
font-size: 26px;
font-weight: bold;
}

/* İşçi ekleme kutusu */
.isciEkleBox {
border: 3px solid #000;
padding: 15px;
border-radius: 15px;
width: 300px;
margin-top: 25px;
}

.isciEkleBox input {
width: 90%;
padding: 10px;
margin-bottom: 10px;
font-size: 18px;
}

.isciEkleBtn {
padding: 10px 20px;
font-size: 18px;
font-weight: bold;
background: #66b3ff;
color: white;
border: none;
cursor: pointer;
border-radius: 10px;
width: 100%;
}

/* İşçi satırı */
.isciSatir {
display: flex;
align-items: center;
margin-top: 25px;
border-bottom: 1px solid #eee;
padding-bottom: 15px;
}

.isciKart {
border: 3px solid black;
padding: 20px 30px;
border-radius: 20px;
width: 200px;
font-size: 28px;
font-weight: bold;
text-align: center;
margin-right: 40px;
}

.puantajBtn {
padding: 12px 20px;
border-radius: 12px;
font-size: 20px;
font-weight: bold;
color: white;
border: none;
cursor: pointer;
margin-right: 15px;
}

.tam { background-color: #77dd77; }
.yarim { background-color: #66b3ff; }
.gelmedi { background-color: #ff4d4d; }

.silBtn {
background-color: black;
color: white;
padding: 10px 18px;
border-radius: 10px;
font-size: 18px;
margin-left: 20px;
cursor: pointer;
}

.ozet {
font-size: 18px;
font-weight: bold;
margin-left: 25px;
}

.aylikBtn {
padding: 10px 18px;
background: #ffaa00;
border: none;
color: white;
font-size: 18px;
border-radius: 10px;
margin-left: 15px;
cursor: pointer;
}

/* Aylık tablo popup */
#aylikPencere {
position: fixed;
top: 0; left: 0;
width: 100%; height: 100%;
background: rgba(0,0,0,0.7);
display: none;
justify-content: center;
align-items: center;
}

#aylikIcerik {
background: white;
padding: 20px;
width: 350px;
border-radius: 15px;
}

table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
}

table, th, td {
border: 1px solid #000;
padding: 5px;
text-align: center;
}

</style>

</head>
<body>
<div id="alertBox" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<div class="baslikRow">
<h2 class="puantajBaslik">PUANTAJ GİRİŞ</h2>
<div class="tarih" id="bugunTarihi"></div>
</div>

<!-- İşçi Ekleme -->
<div class="isciEkleBox">
<h3>Yeni İşçi Ekle</h3>
<input type="text" id="ad" placeholder="Ad Soyad">
<button class="isciEkleBtn" onclick="isciEkle()">Ekle</button>
</div>

<hr>

<!-- İşçi Listesi -->
<div id="isciler"></div>

<!-- Aylık tablo popup -->
<div id="aylikPencere">
<div id="aylikIcerik">
<h3 id="aylikBaslik"></h3>
<table id="aylikTablo"></table>
<button onclick="kapat()">Kapat</button>
</div>
</div>

<script type="module">

/* ------------------- Firebase ------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
getFirestore, collection, addDoc, onSnapshot,
deleteDoc, doc, setDoc, getDocs
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyD91u6_mbbdbQ7fYpTLM9sCagwpP7tqRls",
authDomain: "oryap-puantaj.firebaseapp.com",
projectId: "oryap-puantaj",
storageBucket: "oryap-puantaj.appspot.com",
messagingSenderId: "256704267578",
appId: "1:256704267578:web:5e44ea4648aee07fd77c03"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Bugünün tarihi */
document.getElementById("bugunTarihi").innerText =
new Date().toLocaleDateString("tr-TR");

/* ------------ İşçi Ekleme -------------- */
window.isciEkle = async function() {
const ad = document.getElementById("ad").value.trim();

    if (!ad) return showAlert("İsim giriniz!", "warning");

await addDoc(collection(db, "isciler"), { ad });
document.getElementById("ad").value = "";
   
   showAlert("İşçi başarıyla eklendi!", "success");
};

/* ------------ Puantaj Kaydet (tarih seçilebilir) ------------- */
window.puanEkleGun = async function(isciID, puan) {
const tarih = document.getElementById("tarih_" + isciID).value;

    if (!tarih) return alert("Tarih seç!");
    if (!tarih) return showAlert("Tarih seç!","warning");

await setDoc(
doc(db, "isciler", isciID, "puantaj", tarih),
{ puan },
{ merge: true }
);

 showAlert("Puantaj kaydedildi.", "info");

};

/* ------------ İşçi Sil ------------- */
window.sil = async function(id) {
if (!confirm("İşçiyi silmek istiyor musun?")) return;

await deleteDoc(doc(db, "isciler", id));

    
  showAlert("İşçi silindi!", "danger");

};

/* ------------ Aylık Tablo Göster ------------- */
window.aylikGoster = async function(isciID, ad) {
const ay = prompt("Ay Seç (YYYY-MM) Örn: 2025-01");
if (!ay) return;

const ref = collection(db, "isciler", isciID, "puantaj");
const snap = await getDocs(ref);

let gunler = {};

// 01-31 arası boş tablo
for (let i=1; i<=31; i++) {
gunler[String(i).padStart(2,"0")] = "-";
}

snap.forEach(d => {
const tarih = d.id;  // 2025-01-15
if (tarih.startsWith(ay)) {
const gun = tarih.split("-")[2];
gunler[gun] = d.data().puan;
}
});

// tabloyu doldur
let html = "<tr><th>Gün</th><th>Durum</th></tr>";

for (let g in gunler) {
html += `<tr><td>${g}</td><td>${gunler[g]}</td></tr>`;
}

document.getElementById("aylikBaslik").innerText = ad + " - " + ay + " Puantaj";
document.getElementById("aylikTablo").innerHTML = html;
document.getElementById("aylikPencere").style.display = "flex";
};

window.kapat = function() {
document.getElementById("aylikPencere").style.display = "none";
};

/* ------------ İşçileri Listele ------------- */
onSnapshot(collection(db, "isciler"), async (snapshot) => {
const liste = document.getElementById("isciler");
liste.innerHTML = "";

for (const docu of snapshot.docs) {
const isci = docu.data();
const id = docu.id;

/* Puantaj özetini al */
const puantajRef = collection(db, "isciler", id, "puantaj");
const pSnap = await getDocs(puantajRef);

let tam = 0, yarim = 0, gelmedi = 0;

pSnap.forEach(p => {
const durum = p.data().puan;
if (durum === "tam") tam++;
if (durum === "yarım") yarim++;
if (durum === "gelmedi") gelmedi++;
});

liste.innerHTML += `
       <div class="isciSatir">

           <div class="isciKart">${isci.ad}</div>

           <input type="date" id="tarih_${id}" style="margin-right:10px;">

           <button class="puantajBtn tam" onclick="puanEkleGun('${id}', 'tam')">Tam</button>
           <button class="puantajBtn yarim" onclick="puanEkleGun('${id}', 'yarım')">Yarım</button>
           <button class="puantajBtn gelmedi" onclick="puanEkleGun('${id}', 'gelmedi')">Gelmedi</button>

           <div class="ozet">
               ✔ Tam: ${tam} |
               ➗ Yarım: ${yarim} |
               ✖ Gelmedi: ${gelmedi}
           </div>

           <button class="aylikBtn" onclick="aylikGoster('${id}', '${isci.ad}')">Aylık Tablo</button>

           <button class="silBtn" onclick="sil('${id}')">Sil</button>

       </div>
       `;
}
});

</script>
<script>
window.showAlert = function(message, type = "success") {
const id = "alert_" + Date.now();

const html = `
       <div id="${id}" class="alert alert-${type} alert-dismissible fade show" role="alert"
            style="min-width:250px; font-size:17px; box-shadow:0px 4px 10px rgba(0,0,0,0.2);">
           ${message}
           <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
       </div>
   `;

document.getElementById("alertBox").innerHTML += html;

// 3 saniye sonra otomatik kapanır
setTimeout(() => {
const el = document.getElementById(id);
if (el) el.remove();
}, 3000);
};
</script>

</body>
</html>

